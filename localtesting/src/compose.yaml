name: omgservers

services:
  postgres:
    image: "postgres:17.6"
    container_name: "postgres"
    restart: unless-stopped
    environment:
      POSTGRES_USER: "omgservers"
      POSTGRES_PASSWORD: "omgservers"
      POSTGRES_DB: "omgservers"
      PAGER: "cat"
    ports:
      - "5432:5432"
    networks:
      - omgservers
    volumes:
      - ./01-init.sql:/docker-entrypoint-initdb.d/01-init.sql:r
  redis:
    image: redis:8.2
    container_name: "redis"
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - omgservers
  keycloak:
    image: "quay.io/keycloak/keycloak:26.3"
    container_name: "keycloak"
    restart: unless-stopped
    entrypoint: /opt/keycloak/bin/kc.sh start-dev --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/omgservers
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KC_DB_SCHEMA: keycloak
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: true
      KC_BOOTSTRAP_ADMIN_USERNAME: "admin"
      KC_BOOTSTRAP_ADMIN_PASSWORD: "admin"
    ports:
      - "8000:8080"
    networks:
      - omgservers
    volumes:
      - ./omgplayer-realm.json:/opt/keycloak/data/import/omgplayer-realm.json:r
      - ./omgusers-realm.json:/opt/keycloak/data/import/omgusers-realm.json:r
  omgservice:
    image: "omgservers/omgservice:${OMGSERVERS_VERSION}"
    container_name: "omgservice"
    restart: unless-stopped
    environment:
      DATABASE_URL: jdbc:postgresql://postgres:5432/omgservers?current_schema=omgservice
      DATABASE_USERNAME: omgservice
      DATABASE_PASSWORD: omgservice
    ports:
      - "8001:8080"
    networks:
      - omgservers
    volumes:
      - ./omgplayer-realm.json:/opt/keycloak/data/import/omgplayer-realm.json:r
      - ./omgusers-realm.json:/opt/keycloak/data/import/omgusers-realm.json:r
networks:
  omgservers:
    name: omgservers
